{% extends "base.html" %}

{% block title %}Progresso do Inventário{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="space-y-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold">Dashboard de Progresso</h1>
            <p class="text-gray-600">Acompanhamento de: <span class="font-semibold">{{ inventario.descricao }}</span></p>
        </div>
        <a href="{{ url_for('selecionar_progress_dashboard') }}" class="text-sm text-indigo-600 hover:underline">
            &larr; Voltar à seleção
        </a>
    </div>

    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Progresso em Quantidades</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
            <div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i class="ri-file-list-3-line ri-2x"></i></div>
            <div class="ml-4">
                <p class="text-gray-500">Total de Contagens Realizadas</p>
                <p class="text-3xl font-bold text-[#012E23]">{{ metricas.TotalContagens or 0 }}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
             <div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i class="ri-barcode-box-line ri-2x"></i></div>
            <div class="ml-4">
                <p class="text-gray-500">Itens Únicos Contados</p>
                <p class="text-3xl font-bold text-[#012E23]">{{ metricas.ItensUnicosContados or 0 }}</p>
            </div>
        </div>
    </div>
    
    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Progresso Financeiro (em Tempo Real)</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
            <div class="bg-indigo-100 text-indigo-600 p-4 rounded-full"><i class="ri-wallet-3-line ri-2x"></i></div>
            <div class="ml-4">
                <p class="text-gray-500">Valor Total Contado</p>
                <p class="text-2xl font-bold">{{ metricas.ValorTotalContado|currency }}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
            <div class="bg-green-100 text-green-700 p-4 rounded-full"><i class="ri-arrow-up-line ri-2x"></i></div>
            <div class="ml-4">
                <p class="text-gray-500">Valor Parcial em Sobra</p>
                <p class="text-2xl font-bold text-green-700">{{ metricas.ValorSobraParcial|currency }}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
            <div class="bg-red-100 text-red-700 p-4 rounded-full"><i class="ri-arrow-down-line ri-2x"></i></div>
            <div class="ml-4">
                <p class="text-gray-500">Valor Parcial em Falta</p>
                <p class="text-2xl font-bold text-red-700">{{ metricas.ValorFaltaParcial|currency }}</p>
            </div>
        </div>
    </div>


    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">Ranking de Operadores</h2>
            <div class="relative h-80 w-full">
                <canvas id="usuariosChart"></canvas>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">Últimas Contagens Realizadas</h2>
            <ul class="space-y-4">
                {% for item in feed %}
                <li class="border-b pb-3">
                    <p class="font-semibold text-gray-800">{{ item.codigo_item }} - {{ item.B1_DESC }}</p>
                    <div class="flex justify-between text-sm text-gray-500 mt-1">
                        <span>Qtd: <span class="font-bold text-blue-600 font-mono">{{ "%.2f"|format(item.quantidade_contada) }}</span></span>
                        <span>Valor Contado: <span class="font-bold text-indigo-600 font-mono">{{ (item.quantidade_contada * item.custo_unitario)|currency }}</span></span>
                        <span>Por: {{ item.username }}</span>
                    </div>
                </li>
                {% else %}
                <li class="text-center text-gray-500 pt-4">Nenhuma atividade de contagem ainda.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ctxUsuarios = document.getElementById('usuariosChart').getContext('2d');
        new Chart(ctxUsuarios, {
            type: 'bar',
            data: {
                labels: {{ chart_labels|tojson }},
                datasets: [{
                    label: 'Número de Contagens',
                    data: {{ chart_data|tojson }},
                    backgroundColor: '#012E23',
                    borderColor: '#05B540',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    });
</script>
{% endblock %}